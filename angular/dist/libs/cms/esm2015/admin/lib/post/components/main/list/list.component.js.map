{"version":3,"file":"list.component.js","sourceRoot":"","sources":["../../../../../../../../../../libs/cms/admin/src/lib/post/components/main/list/list.component.ts"],"names":[],"mappings":"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","sourcesContent":["import { Component, Injector, OnInit, ViewChild,OnDestroy } from '@angular/core';\r\nimport { FileService } from '../../../../shared'\r\nimport { Fs } from '@fs-tw/cms/proxy';\r\nimport { PageService } from '../../../providers/page.service';\r\nimport { PostStateService } from '../../../providers/post-state.service';\r\nimport { ListService } from '@abp/ng.core';\r\nimport {\r\n  EXTENSIONS_IDENTIFIER,\r\n  FormPropData,\r\n  generateFormFromProps,\r\n} from '@abp/ng.theme.shared/extensions';\r\nimport { eCmsRouteNames, ExtensionsService } from '@fs-tw/cms/config';\r\nimport { FormGroup } from '@angular/forms';\r\nimport { ImageFile, ImagePickerComponent } from '../../image-picker/image-picker.component';\r\nimport { Observable, Subscriber, Subscription } from 'rxjs';\r\nimport {\r\n  Confirmation,\r\n  ConfirmationService,\r\n  ToasterService,\r\n} from '@abp/ng.theme.shared';\r\nimport { Router, ActivatedRoute } from '@angular/router';\r\n@Component({\r\n  selector: 'fs-list',\r\n  templateUrl: './list.component.html',\r\n  styleUrls: ['./list.component.css'],\r\n  providers: [\r\n    ListService,\r\n    {\r\n      provide: EXTENSIONS_IDENTIFIER,\r\n      useValue: eCmsRouteNames.Blog,\r\n    },\r\n  ],\r\n})\r\nexport class ListComponent implements OnInit,OnDestroy {\r\n  @ViewChild(\"DefaultImagePicker\") defaultImagePicker: ImagePickerComponent;\r\n  datas: Fs.Cms.Blogs.Dtos.BlogDto[] = [];\r\n  count = 0;\r\n  defaultImages: ImageFile[] = [];\r\n  isVisible = false;\r\n  form: FormGroup;\r\n  selected: Fs.Cms.Blogs.Dtos.BlogDto = {} as Fs.Cms.Blogs.Dtos.BlogDto\r\n  directory;\r\n  defaultSelectId = null;\r\n  sub: Subscription;\r\n  constructor(\r\n    private router: Router,\r\n    private extensionsService: ExtensionsService,\r\n    private pageService: PageService,\r\n    protected injector: Injector,\r\n    public readonly list: ListService,\r\n    private fileService: FileService,\r\n    private toasterService: ToasterService,\r\n    private activatedRoute: ActivatedRoute,\r\n    private confirmationService: ConfirmationService,\r\n    private postStateService: PostStateService\r\n  ) {\r\n    \r\n\r\n    this.activatedRoute.queryParamMap.subscribe(x => {\r\n      this.defaultSelectId = x.get(\"blogId\");\r\n\r\n      this.pageService.findByProviderByKeyAndGroup(\"FS.Cms.Blogs\",this.defaultSelectId?this.defaultSelectId:this.getRand()).subscribe(x => {\r\n        this.directory = x;\r\n      })\r\n    })\r\n  }\r\n  ngOnDestroy(): void {\r\n    if(this.sub) this.sub.unsubscribe();\r\n  }\r\n\r\n  getRand() {\r\n    return (Math.floor(Math.random() * 100) + 1).toString();\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.sub = this.extensionsService.Actions$[eCmsRouteNames.Blog].subscribe(\r\n      (x) => {\r\n        switch (x.name) {\r\n          case 'Edit':\r\n            this.edit(x.record.id);\r\n            break;\r\n          case 'Delete':\r\n            this.deleteBlog(x.record)\r\n            break;\r\n          case 'Add':\r\n            this.add();\r\n            break;\r\n        }\r\n      }\r\n    );\r\n\r\n    this.reload();\r\n  }\r\n\r\n  reload() {\r\n\r\n    let input: Fs.Cms.Blogs.Dtos.BlogGetListDto = {\r\n      skipCount: 0,\r\n      maxResultCount: 10,\r\n      sorting: 'sequence'\r\n    } as Fs.Cms.Blogs.Dtos.BlogGetListDto;\r\n\r\n    const customerStreamCreator = (query) => {\r\n      return this.pageService.getBlogs(input)\r\n    };\r\n\r\n    this.list.hookToQuery(customerStreamCreator).subscribe((res) => {\r\n      this.datas = res.items;\r\n      this.count = res.totalCount;\r\n      if (this.defaultSelectId) {\r\n        let select = this.datas.find(x => x.id == this.defaultSelectId);\r\n        this.showDetail(select)\r\n      }\r\n    });\r\n  }\r\n\r\n  showDetail(blog: Fs.Cms.Blogs.Dtos.BlogDto) {\r\n    if (blog == null) {\r\n      this.router.navigate(['./cms/post'])\r\n      this.postStateService.setBlog(null);\r\n      return;\r\n    }\r\n    this.router.navigate(['./cms/post'], { queryParams: { 'blogId': blog.id } })\r\n    this.postStateService.setBlog(blog);\r\n  }\r\n\r\n  deleteBlog(blog: Fs.Cms.Blogs.Dtos.BlogDto) {\r\n    this.confirmationService\r\n      .warn('確認要刪除嗎？(此Blog下的文章將移至不分類)', '系統訊息', {\r\n        cancelText: \"取消\",\r\n        yesText: \"確定\"\r\n      })\r\n      .subscribe((status: Confirmation.Status) => {\r\n        if (status === Confirmation.Status.confirm) {\r\n          this.pageService.deleteBlog(blog.id).subscribe(x => {\r\n            this.toasterService.success(\"刪除成功！\")\r\n            this.list.get();\r\n            this.router.navigate([\"./cms/post\"])\r\n          })\r\n        }\r\n      });\r\n  }\r\n\r\n\r\n\r\n  handleCancel() {\r\n    this.isVisible = false;\r\n  }\r\n\r\n  save() {\r\n    if (!this.form.valid) return;\r\n    let deleteImageNames = this.defaultImagePicker.getDeleteFileNames();    \r\n    if(deleteImageNames.length>0){\r\n      this.pageService.deleteFile(deleteImageNames[0]).subscribe(()=>{\r\n        this.uploadFile();\r\n      });\r\n    } else this.uploadFile();\r\n    \r\n  }\r\n\r\n\r\n  uploadFile(){\r\n    let uploadImageInfos = this.defaultImagePicker.getUploadFiles();\r\n    let fileId = \"\";\r\n    if ((uploadImageInfos.length > 0)) {\r\n      if (this.selected.iconUrl == uploadImageInfos[0].fileName) {\r\n        this.saveBlog(this.selected.iconUrl);\r\n        return;\r\n      }\r\n      this.fileService.uploadFile(uploadImageInfos[0].file, this.directory.id).subscribe(x => {\r\n        fileId = x.id;\r\n        this.saveBlog(fileId);\r\n      })\r\n    } else this.saveBlog(\"\");\r\n  }\r\n\r\n  saveBlog(fileId?) {\r\n    let input = { ...this.selected, ...this.form.value, id: this.selected.id };\r\n    input.iconUrl = fileId;\r\n    let action: Observable<any>;\r\n    if (input.id) action = this.pageService.updateBlog(input.id, input);\r\n    else {\r\n      input.no = input.displayName;\r\n      action = this.pageService.createBlog(input);\r\n    }\r\n    action.subscribe((x) => {\r\n      this.toasterService.success('修改成功！');\r\n      this.isVisible = false;\r\n      this.list.get();\r\n    });\r\n  }\r\n\r\n  add() {\r\n    this.selected = {} as any;\r\n    this.defaultImages = []\r\n    this.openModal();\r\n  }\r\n\r\n  edit(id: string) {\r\n    this.pageService.getBlogById(id).subscribe(x => {\r\n      this.selected = x;\r\n      this.defaultImages = []\r\n      if (x.iconUrl) this.defaultImages.push(new ImageFile(x.iconUrl, x.iconUrl))\r\n      this.openModal();\r\n    })\r\n  }\r\n\r\n  buildForm() {\r\n    const data = new FormPropData(this.injector, this.selected);\r\n    this.form = null;\r\n    this.form = generateFormFromProps(data);\r\n  }\r\n\r\n  openModal() {\r\n    this.buildForm();\r\n    this.isVisible = true;\r\n  }\r\n\r\n}\r\n"]}