{"version":3,"file":"main.component.js","sourceRoot":"","sources":["../../../../../../../../../libs/cms/admin/src/lib/post/components/main/main.component.ts"],"names":[],"mappings":"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","sourcesContent":["import { ListService } from '@abp/ng.core';\r\nimport { Confirmation, ConfirmationService, ToasterService } from '@abp/ng.theme.shared';\r\nimport {\r\n  EXTENSIONS_IDENTIFIER\r\n} from '@abp/ng.theme.shared/extensions';\r\nimport { Component, OnInit } from '@angular/core';\r\nimport { ActivatedRoute, Router } from '@angular/router';\r\nimport { eCmsRouteNames, ExtensionsService } from '@fs-tw/cms/config';\r\nimport { Fs } from '@fs-tw/cms/proxy';\r\nimport { forkJoin, Observable, Subscription } from 'rxjs';\r\nimport { PageService } from '../../providers/page.service';\r\nimport { PostStateService } from '../../providers/post-state.service';\r\n\r\n\r\n@Component({\r\n  selector: 'fs-main',\r\n  templateUrl: './main.component.html',\r\n  styleUrls: ['./main.component.less'],\r\n  providers: [\r\n    ListService,\r\n    {\r\n      provide: EXTENSIONS_IDENTIFIER,\r\n      useValue: eCmsRouteNames.Post,\r\n    },\r\n  ],\r\n})\r\nexport class MainComponent implements OnInit {\r\n  sub: Subscription;\r\n  blog$: Observable<Fs.Cms.Blogs.Dtos.BlogDto>;\r\n  blogId: string;\r\n  blogName: string;\r\n  hookToQueryScribe: Subscription;\r\n  postParams: Fs.Cms.Posts.Dtos.GetPostByBlogIdInput = {\r\n    skipCount: 0,\r\n    maxResultCount: 10,\r\n    keyword: \"\",  \r\n    blogId: null\r\n  } as Fs.Cms.Posts.Dtos.GetPostByBlogIdInput;\r\n\r\n  posts: Fs.Cms.Posts.Dtos.PostWithDetailsDto[] = [];\r\n  totalCount: number = 0;\r\n\r\n  constructor(\r\n    private extensionsService: ExtensionsService,\r\n    private router: Router,\r\n    private toasterService: ToasterService,\r\n    private confirmationService: ConfirmationService,\r\n    private pageService: PageService,\r\n    public readonly list: ListService,\r\n    private activatedRoute: ActivatedRoute,\r\n    private postStateService: PostStateService\r\n  ) {\r\n\r\n  }\r\n\r\n\r\n\r\n  ngOnInit() {\r\n    this.extensionsService.Actions$[eCmsRouteNames.Post].subscribe(\r\n      (x) => {\r\n        switch (x.name) {\r\n          case 'Edit':\r\n            this.gotoDetail(x.record.id)\r\n            break;\r\n          case 'Delete':\r\n            this.deleteItem(x.record)\r\n            break;\r\n        }\r\n      });\r\n\r\n    this.blog$ = this.postStateService.getBlog();\r\n    this.onBlogChange();\r\n  }\r\n\r\n  onBlogChange() {\r\n    this.sub = this.blog$.subscribe((blog) => {\r\n      this.blogId = blog == null ? null : blog.id;\r\n      this.blogName = blog == null ? \"全部\" : blog.displayName;\r\n\r\n      this.postParams.blogId = this.blogId;\r\n      this.hookToQuery();\r\n    })\r\n  }\r\n\r\n  gotoDetail(id?: string) {\r\n    if (id) this.router.navigate([\"/cms/post/detail/\" + id]);\r\n    else this.router.navigate([\"/cms/post/detail\"], {\r\n      queryParams: {\r\n        blogId: this.postParams.blogId\r\n      }\r\n    });\r\n  }\r\n\r\n  hookToQuery() {\r\n\r\n    if (this.hookToQueryScribe) this.hookToQueryScribe.unsubscribe();\r\n    const query = (query) => {\r\n      query.keyword = this.postParams.keyword;\r\n      query.blogId = this.postParams.blogId;\r\n      return this.pageService.getPostsByBlogId(query)\r\n    };\r\n\r\n    this.hookToQueryScribe = this.list.hookToQuery(query).subscribe((res) => {\r\n      this.posts = res.items;\r\n      this.totalCount = res.totalCount;\r\n    });\r\n  }\r\n\r\n  deleteItem(item: Fs.Cms.Posts.Dtos.PostDto) {\r\n    this.confirmationService\r\n      .warn('確認要刪除嗎？', '系統訊息', {\r\n        cancelText: \"取消\",\r\n        yesText: \"確定\"\r\n      })\r\n      .subscribe((status: Confirmation.Status) => {\r\n        if (status === Confirmation.Status.confirm) {\r\n          let files = item.attachmentFileInfos.map(x => x.fileId)\r\n          let images = item.postImages.map(x => x.imageId);\r\n          let deleteFileActions = files.concat(images).map(x => this.pageService.deleteFile(x));\r\n          forkJoin(deleteFileActions).subscribe();\r\n\r\n          this.pageService.deletePost(item.id).subscribe(x => {\r\n            this.toasterService.success(\"刪除成功！\")\r\n            this.list.get();\r\n          })\r\n        }\r\n      });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.hookToQueryScribe) this.hookToQueryScribe.unsubscribe();\r\n    if (this.sub) this.sub.unsubscribe();\r\n  }\r\n\r\n}\r\n"]}